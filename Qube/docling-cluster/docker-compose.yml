version: "3.9"

services:
  # === Infrastructure ===
  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    healthcheck:
      test: [ "CMD", "redis-cli", "ping" ]
      interval: 5s
      timeout: 3s
      retries: 3

  qdrant:
    image: qdrant/qdrant:latest
    ports:
      - "6333:6333"
    volumes:
      - qdrant_data:/qdrant/storage
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:6333/health" ]
      interval: 10s
      timeout: 5s
      retries: 3

  # === Application Services ===
  ingest_api:
    build:
      context: .
      dockerfile: ./ingest_api/Dockerfile
    ports:
      - "8000:8000"
    environment:
      - REDIS_URL=redis://redis:6379
      - DATA_DIR=/app/data
    volumes:
      - shared_data:/app/data
    depends_on:
      redis:
        condition: service_healthy

  docling_worker:
    build:
      context: .
      dockerfile: ./docling_worker/Dockerfile
    environment:
      - REDIS_URL=redis://redis:6379
      - LEDGER_URL=http://ledger:8001
      - DATA_DIR=/app/data
    volumes:
      - shared_data:/app/data
    depends_on:
      redis:
        condition: service_healthy
      ledger:
        condition: service_started

  embed-worker:
    build:
      context: .
      dockerfile: ./services/embed-worker/Dockerfile
    environment:
      - REDIS_URL=redis://redis:6379
      - QDRANT_URL=http://qdrant:6333
      - LEDGER_URL=http://ledger:8001
      - CAPSULE_URL=http://capsule-model:8002
    depends_on:
      redis:
        condition: service_healthy
      qdrant:
        condition: service_healthy
      ledger:
        condition: service_started
      capsule-model:
        condition: service_started

  capsule-model:
    build:
      context: .
      dockerfile: ./services/capsule-model/Dockerfile
    ports:
      - "8002:8002"
    environment:
      - REDIS_URL=redis://redis:6379
      - LORA_REGISTRY_PATH=/app/data/lora_registry
    volumes:
      - lora_data:/app/data/lora_registry
    depends_on:
      redis:
        condition: service_healthy

  ledger:
    build:
      context: .
      dockerfile: ./services/ledger/Dockerfile
    ports:
      - "8001:8001"
    environment:
      - LEDGER_PATH=/app/data/ledger.jsonl
    volumes:
      - ledger_data:/app/data

volumes:
  qdrant_data:
  ledger_data:
  shared_data:
  lora_data:
